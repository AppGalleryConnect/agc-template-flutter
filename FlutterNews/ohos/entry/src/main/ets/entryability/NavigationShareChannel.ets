/**
 * Flutter å’Œé¸¿è’™åŸç”Ÿé¡µé¢äº’ç›¸è·³è½¬çš„é€šé“
 */
import { MethodChannel, MethodCall, MethodResult, FlutterPlugin, FlutterPluginBinding } from '@ohos/flutter_ohos';
import { common } from '@kit.AbilityKit';
import { promptAction, router } from '@kit.ArkUI';

import { scanBarcode, scanCore } from '@kit.ScanKit';
import { BusinessError } from '@kit.BasicServicesKit';

const TAG = '[NavigationChannel]';


export class NavigationChannel implements FlutterPlugin {
  private channel?: MethodChannel;
  private context: common.UIAbilityContext;

  constructor(context: common.UIAbilityContext) {
    this.context = context;
  }

  getUniqueClassName(): string {
    return 'NavigationChannel';
  }

  onAttachedToEngine(binding: FlutterPluginBinding): void {
    console.info(TAG, 'ğŸš€ å¼€å§‹æ³¨å†Œ NavigationChannel');

    this.channel = new MethodChannel(
      binding.getBinaryMessenger(),
      'com.news.flutter/navigation'
    );

    this.channel.setMethodCallHandler({
      onMethodCall: (call: MethodCall, result: MethodResult): void => {
        console.info(TAG, `âš¡ æ”¶åˆ°æ–¹æ³•è°ƒç”¨: ${call.method}`);
        this.handleMethodCall(call, result);
      }
    });

    console.info(TAG, 'âœ… NavigationChannel æ³¨å†ŒæˆåŠŸ');
  }

  onDetachedFromEngine(binding: FlutterPluginBinding): void {
    if (this.channel) {
      this.channel.setMethodCallHandler(null);
    }
  }

  /**
   * å¤„ç† Flutter çš„æ–¹æ³•è°ƒç”¨
   */
  private handleMethodCall(call: MethodCall, result: MethodResult): void {
    console.info(TAG, `å¤„ç†æ–¹æ³•: ${call.method}`);

    switch (call.method) {
      case 'pushNativePage':
        this.pushNativePage(call.args, result);
        break;
      case 'popNativePage':
        this.popNativePage(result);
        break;
      case 'scan':
        this.scan(result);
        break;
      default:
        console.warn(TAG, `æœªå®ç°çš„æ–¹æ³•: ${call.method}`);
        result.notImplemented();
        break;
    }
  }

  /**
   * è·³è½¬åˆ°é¸¿è’™åŸç”Ÿé¡µé¢
   */
  private pushNativePage(args: Object, result: MethodResult): void {
    try {

      // args æ˜¯ä¸€ä¸ª Map å¯¹è±¡ï¼Œä½¿ç”¨ Map çš„ API è®¿é—®
      const argsMap = args as Map<string, Object>;

      // ä½¿ç”¨ Map.get() æ–¹æ³•è·å–å€¼
      const pageName = argsMap.get('pageName') as string;
      const paramsRaw = argsMap.get('params');


      // å°† params è½¬æ¢ä¸ºæ™®é€šå¯¹è±¡
      let params: Record<string, Object> = {};

      if (paramsRaw) {
        // å¦‚æœ params ä¹Ÿæ˜¯ Mapï¼Œéœ€è¦è½¬æ¢
        if (paramsRaw instanceof Map) {
          console.info(TAG, `params æ˜¯ Mapï¼Œè½¬æ¢ä¸­...`);
          const paramsMap = paramsRaw as Map<string, Object>;
          paramsMap.forEach((value: Object, key: string) => {
            params[key] = value;
          });
        } else {
          // å¦‚æœæ˜¯æ™®é€šå¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨
          params = paramsRaw as Record<string, Object>;
        }
      }

      // ç›´æ¥ä½¿ç”¨ router.pushUrl è·³è½¬
      const pageUrl = `pages/${pageName}`;

      router.pushUrl({
        url: pageUrl,
        params: params
      }).then(() => {
        console.info(TAG, `âœ… è·³è½¬æˆåŠŸ: ${pageName}`);
        result.success(true);
      }).catch((err: Error) => {
        console.error(TAG, `âŒ router.pushUrl å¤±è´¥: ${err.message}`);
        result.success(true);
      });

    } catch (err) {
      const error = err as Error;
      console.error(TAG, `å¤„ç†å¼‚å¸¸: ${error.message}`);
      result.error('ERROR', error.message, null);
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  private popNativePage(result: MethodResult): void {
    try {
      console.info(TAG, 'ğŸ”™ è¯·æ±‚è¿”å›ä¸Šä¸€é¡µ');

      // é€šè¿‡ eventHub é€šçŸ¥ Index.ets æ‰§è¡Œ pop
      this.context.eventHub.emit('EVENT_POP_PAGE', {});

      console.info(TAG, 'âœ… è¿”å›äº‹ä»¶å·²å‘é€');
      result.success(true);
    } catch (err) {
      const error = err as Error;
      console.error(TAG, `è¿”å›å¤±è´¥: ${error.message}`);
      result.error('POP_ERROR', error.message, null);
    }
  }

  private scan(scanResult: MethodResult): void {
    // å®šä¹‰æ‰«ç å‚æ•°options
    let options: scanBarcode.ScanOptions = {
      scanTypes: [scanCore.ScanType.ALL],
      enableMultiMode: true,
      enableAlbum: true,
    };
    try {
      // å¯è°ƒç”¨getContextæ¥å£è·å–å½“å‰é¡µé¢å…³è”çš„UIAbilityContext
      scanBarcode.startScanForResult(getContext(this), options).then((result: scanBarcode.ScanResult) => {
        // è§£æç å€¼ç»“æœè·³è½¬åº”ç”¨æœåŠ¡é¡µ
        let resultParams: Record<string, string> = JSON.parse(result.originalValue)
        if (!resultParams?.articleId) {
          promptAction.showToast({ message: 'æ‰«ç é”™è¯¯ï¼Œä»…æ”¯æŒæ¨¡æ¿å†…æ–‡ç« æµ·æŠ¥ç”Ÿæˆçš„äºŒç»´ç ' })
          return
        }
        let routerParams = {
          'id': resultParams?.articleId,
        } as Record<string, string>
        // RouterToNews.routerToNewsById(routerParams.id)
        scanResult.success(routerParams.id);
      }).catch((error: BusinessError) => {
        let message: string = ''
        if (error.code === 1000500002) {
          // ç”¨æˆ·å–æ¶ˆæ‰«ç 
          message = 'å–æ¶ˆæ‰«ç '
        } else {
          message = 'æ‰«ç é”™è¯¯'
        }
        promptAction.showToast({ message: message })
      });
    } catch (error) {
      promptAction.showToast({ message: 'æ‰«ç é”™è¯¯' })
    }
  }
}

